<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualizador 3D</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
    
    <!-- 1. CARREGUE TODAS AS DEPENDÊNCIAS NA ORDEM CORRETA -->
    <!-- Three.js principal -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    
    <!-- DRACO loader (agora carregado antes do GLTFLoader) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/libs/draco/gltf/draco_wasm_wrapper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/libs/draco/draco_decoder.js"></script>
    
    <!-- GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
    
    <!-- OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.min.js"></script>
    
    <!-- Tween.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.min.js"></script>
</head>
<body>
    <script>
        // 2. CONFIGURAÇÃO DO DRACOLoader CORRETAMENTE
        // Primeiro verifique se DRACOLoader está disponível
        if (typeof THREE.DRACOLoader === 'undefined') {
            // Se não estiver, carregue dinamicamente
            const dracoScript = document.createElement('script');
            dracoScript.src = 'https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/DRACOLoader.min.js';
            dracoScript.onload = initApp;
            document.head.appendChild(dracoScript);
        } else {
            initApp();
        }

        function initApp() {
            // 3. AGORA SIM INICIALIZE O DRACOLoader
            const dracoLoader = new THREE.DRACOLoader();
            dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/libs/draco/');
            
            // 4. CONFIGURE O GLTFLoader
            const loader = new THREE.GLTFLoader();
            loader.setDRACOLoader(dracoLoader);

            // 5. CENA, CÂMERA E RENDERER
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // 6. CONTROLES E LUZES
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            const light = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(light);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            // 7. CARREGUE O MODELO
            loader.load(
                'modelo.glb',
                function(gltf) {
                    console.log('Modelo carregado com sucesso!');
                    scene.add(gltf.scene);
                    
                    // Lista todos os objetos no console
                    gltf.scene.traverse(function(child) {
                        if (child.isMesh) {
                            console.log('Objeto:', child.name);
                        }
                    });
                },
                undefined,
                function(error) {
                    console.error('Erro ao carregar modelo:', error);
                }
            );

            // 8. ANIMAÇÃO
            function animate() {
                requestAnimationFrame(animate);
                if (window.TWEEN) TWEEN.update();
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 9. FUNÇÃO PARA FOCAR EM OBJETOS
            window.focusOnObject = function(objectName) {
                scene.traverse(function(child) {
                    if (child.name === objectName) {
                        const bbox = new THREE.Box3().setFromObject(child);
                        const center = bbox.getCenter(new THREE.Vector3());
                        
                        new TWEEN.Tween(camera.position)
                            .to({
                                x: center.x,
                                y: center.y,
                                z: center.z + 5
                            }, 1000)
                            .start();
                        
                        new TWEEN.Tween(controls.target)
                            .to(center, 1000)
                            .start();
                    }
                });
            };

            // 10. COMUNICAÇÃO COM STREAMLIT
            window.addEventListener('message', function(event) {
                if (event.data.type === 'select-element') {
                    focusOnObject(event.data.elementName);
                }
            });
        }
    </script>
</body>
</html>
