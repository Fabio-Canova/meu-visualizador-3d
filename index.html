

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualizador 3D</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
    
    <!-- 1. CARREGAMENTO CORRETO DAS DEPENDÊNCIAS -->
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    
    <!-- GLTFLoader + DRACOLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/libs/draco/draco_decoder.js"></script>
    
    <!-- OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.min.js"></script>
    
    <!-- Tween.js - VERSÃO CORRETA UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.min.js"></script>
</head>
<body>
    <script>
        // 2. INICIALIZAÇÃO DO DRACOLoader ANTES DO GLTFLoader
        const dracoLoader = new THREE.DRACOLoader();
        dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/libs/draco/');
        
        const loader = new THREE.GLTFLoader();
        loader.setDRACOLoader(dracoLoader);

        // 3. CONFIGURAÇÃO DA CENA
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        // 4. DECLARAÇÃO GLOBAL DO TWEEN
        // Acessa TWEEN do objeto global (window) conforme a versão UMD
        const TWEEN = window.TWEEN;
        
        // 5. VERIFICAÇÃO DE CARREGAMENTO DAS DEPENDÊNCIAS
        if (typeof TWEEN === 'undefined') {
            console.error('TWEEN não foi carregado corretamente!');
        }
        
        if (typeof THREE.DRACOLoader === 'undefined') {
            console.error('DRACOLoader não foi carregado corretamente!');
        }

        // 6. CARREGAMENTO DO MODELO COM TRATAMENTO DE ERROS
        loader.load(
            'modelo.glb',
            function(gltf) {
                console.log('Modelo carregado com sucesso!');
                
                // Processamento dos objetos
                gltf.scene.traverse(function(child) {
                    if (child.isMesh) {
                        console.log('Objeto encontrado:', child.name);
                    }
                });
                
                scene.add(gltf.scene);
            },
            undefined,
            function(error) {
                console.error('Erro ao carregar modelo:', error);
                if (error.message.includes('DRACOLoader')) {
                    console.error('Solução: Verifique se o DRACOLoader foi configurado corretamente');
                }
            }
        );

        // 7. ANIMAÇÃO COM VERIFICAÇÃO DE TWEEN
        function animate() {
            requestAnimationFrame(animate);
            
            // Verifica se TWEEN existe antes de usar
            if (typeof TWEEN !== 'undefined') {
                TWEEN.update();
            } else {
                console.warn('TWEEN não disponível');
            }
            
            renderer.render(scene, camera);
        }
        animate();

        // 8. FUNÇÃO PARA FOCAR EM OBJETOS (COM TWEEN)
        function focusOnObject(objectName) {
            scene.traverse(function(child) {
                if (child.name === objectName) {
                    const bbox = new THREE.Box3().setFromObject(child);
                    const center = bbox.getCenter(new THREE.Vector3());
                    
                    new TWEEN.Tween(camera.position)
                        .to({
                            x: center.x,
                            y: center.y,
                            z: center.z + 5
                        }, 1000)
                        .start();
                }
            });
        }

        // 9. COMUNICAÇÃO COM STREAMLIT
        window.addEventListener('message', function(event) {
            if (event.data.type === 'select-element') {
                focusOnObject(event.data.elementName);
            }
        });
    </script>
</body>
</html>
